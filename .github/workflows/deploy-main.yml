name: Deploy to GCP VM (Ubuntu Optimized)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Ubuntu VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30s
          command_timeout: 10m
          script: |
            set -e
            echo "ðŸš€ Starting Ubuntu-optimized multi-service deployment..."
            
            PROJECT_NAME="${{ github.event.repository.name }}"
            
            # í™ˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~ || exit 1
            
            # ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ íŒŒì¼ ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ìƒì„±)
            if [ ! -f "services-registry.json" ]; then
              echo '{"version":"1.0","services":{},"next_ports":{"frontend":3000,"backend":8000},"last_updated":""}' > services-registry.json
            fi
            
            # í˜„ìž¬ ì„œë¹„ìŠ¤ ìƒí™© í™•ì¸
            echo "ðŸ“‹ Current services status:"
            cat services-registry.json | python3 -m json.tool || echo "Empty registry"
            
            # ì„œë¹„ìŠ¤ í¬íŠ¸ í• ë‹¹ í•¨ìˆ˜
            get_next_ports() {
              FRONTEND_PORT=$(cat services-registry.json | python3 -c "
            import json, sys
            data = json.load(sys.stdin)
            print(data.get('next_ports', {}).get('frontend', 3000))
            " 2>/dev/null || echo "3000")
              
              BACKEND_PORT=$(cat services-registry.json | python3 -c "
            import json, sys
            data = json.load(sys.stdin)
            print(data.get('next_ports', {}).get('backend', 8000))
            " 2>/dev/null || echo "8000")
              
              echo "Next available ports: Frontend:$FRONTEND_PORT, Backend:$BACKEND_PORT"
            }
            
            # í¬íŠ¸ í• ë‹¹
            get_next_ports
            
            # ê¸°ì¡´ í”„ë¡œì íŠ¸ê°€ ìžˆë‹¤ë©´ ê°œë³„ ì„œë¹„ìŠ¤ë§Œ ì—…ë°ì´íŠ¸ (ë¬´ì¤‘ë‹¨)
            if [ -d "$PROJECT_NAME" ]; then
              echo "ðŸ”„ Updating existing service (zero-downtime)..."
              cd "$PROJECT_NAME"
              
              # ì½”ë“œ ì—…ë°ì´íŠ¸
              git fetch origin main
              git reset --hard origin/main
              
              # ê°œë³„ ì„œë¹„ìŠ¤ë§Œ ìž¬ë¹Œë“œ ë° ìž¬ì‹œìž‘ (Ubuntu Docker Compose ì‚¬ìš©)
              export PROJECT_NAME="$PROJECT_NAME"
              docker compose build --parallel backend frontend
              docker compose up -d --no-deps --force-recreate "${PROJECT_NAME}-backend" "${PROJECT_NAME}-frontend"
              
            else
              echo "ðŸ†• Deploying new service..."
              
              # ìµœì‹  ì½”ë“œ í´ë¡ 
              git clone --depth 1 --single-branch --branch main "https://github.com/UTOPBM/$PROJECT_NAME.git"
              cd "$PROJECT_NAME"
              
              # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
              export PROJECT_NAME="$PROJECT_NAME"
              
              # ì„œë¹„ìŠ¤ë³„ Nginx ì„¤ì • ìƒì„±
              mkdir -p nginx/conf.d
              cat > nginx/conf.d/${PROJECT_NAME}.conf << NGINX_EOF
            # $PROJECT_NAME service configuration
            upstream ${PROJECT_NAME}_frontend {
                server ${PROJECT_NAME}-frontend:80;
            }
            
            upstream ${PROJECT_NAME}_backend {
                server ${PROJECT_NAME}-backend:8000;
            }
            
            # Frontend routes
            location /${PROJECT_NAME}/ {
                proxy_pass http://${PROJECT_NAME}_frontend/;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                
                # WebSocket support for Hot Reloading
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection "upgrade";
            }
            
            # API routes  
            location /api/${PROJECT_NAME}/ {
                proxy_pass http://${PROJECT_NAME}_backend/api/;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
            }
            NGINX_EOF
              
              # Ubuntu Docker Composeë¡œ ë¹Œë“œ ë° ì‹œìž‘
              docker compose build --parallel
              docker compose up -d
              
              # ì„œë¹„ìŠ¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì—…ë°ì´íŠ¸
              cd ~
              python3 -c "
            import json
            from datetime import datetime
            
            # ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì½ê¸°
            try:
                with open('services-registry.json', 'r') as f:
                    registry = json.load(f)
            except:
                registry = {'version': '1.0', 'services': {}, 'next_ports': {'frontend': 3000, 'backend': 8000}}
            
            # ìƒˆ ì„œë¹„ìŠ¤ ì¶”ê°€
            registry['services']['$PROJECT_NAME'] = {
                'frontend_port': $FRONTEND_PORT,
                'backend_port': $BACKEND_PORT,
                'path': '/$PROJECT_NAME',
                'status': 'active',
                'deployed_at': datetime.now().isoformat()
            }
            
            # ë‹¤ìŒ í¬íŠ¸ ì—…ë°ì´íŠ¸
            registry['next_ports']['frontend'] = $FRONTEND_PORT + 1
            registry['next_ports']['backend'] = $BACKEND_PORT + 1
            registry['last_updated'] = datetime.now().isoformat()
            
            # ì €ìž¥
            with open('services-registry.json', 'w') as f:
                json.dump(registry, f, indent=2)
            "
            fi
            
            # Nginx í”„ë¡ì‹œê°€ ì‹¤í–‰ ì¤‘ì´ë©´ ì„¤ì • ìƒˆë¡œê³ ì¹¨ (0.1ì´ˆ ë‹¤ìš´íƒ€ìž„ë§Œ)
            if docker ps | grep -q nginx-proxy; then
              echo "ðŸ”„ Reloading Nginx configuration..."
              docker exec $(docker ps -qf "name=nginx-proxy") nginx -s reload || echo "Nginx reload skipped"
            fi
            
            # í—¬ìŠ¤ì²´í¬
            echo "â³ Waiting for services to be ready..."
            sleep 20
            
            echo "=== Final Status ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo "=== Health Check ==="
            curl -f http://localhost/health && echo " âœ… Nginx Proxy OK" || echo " âŒ Nginx Proxy failed"
            curl -f http://localhost/${PROJECT_NAME}/ && echo " âœ… Frontend OK" || echo " âŒ Frontend not ready"
            curl -f http://localhost/api/${PROJECT_NAME}/health && echo " âœ… Backend OK" || echo " âŒ Backend not ready"
            
            echo ""
            echo "âœ… Multi-Service Deployment Complete!"
            echo "ðŸŒ Service Dashboard: http://34.71.236.217/"
            echo "ðŸŽ¯ Your Service: http://34.71.236.217/${PROJECT_NAME}/"
            echo "ðŸ”§ Your API: http://34.71.236.217/api/${PROJECT_NAME}/"
            echo "ðŸ“š API Docs: http://34.71.236.217/api/${PROJECT_NAME}/docs"
